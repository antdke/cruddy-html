<html lang="en">
  <head>
    <title>My Cruddy Todo List</title>
  </head>

  <body>
    <h1>My Cruddy Todo List</h1>

    <div>
      <form>
        <input id="task" type="text" />
        <br />
        <button id="add_task">Submit</button>
      </form>
    </div>
    <div id="result"></div>
    <br />
    <ul id="tasks_list"></ul>

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>

    <!-- Firebase authentication integration -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries -->

    <script>
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyCIM7pQkzLjM0ONYt6vwa-iDBACeSOWPhU",
        authDomain: "cruddy-9545c.firebaseapp.com",
        projectId: "cruddy-9545c",
        storageBucket: "cruddy-9545c.appspot.com",
        messagingSenderId: "571561049081",
        appId: "1:571561049081:web:6bd008d277095e1d36db28",
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      // initialize the db
      db = firebase.firestore();
    </script>
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
    <script>
      // global functions
      function removeAllChildNodes(parent) {
        while (parent.firstChild) {
          parent.removeChild(parent.firstChild);
        }
      }

      $(document).ready(() => {
        // dom refs
        let task = $("#task")[0];
        let add = $("#add_task");
        let result = $("#result");
        let tasks = $("#tasks_list")[0];
        // temp element to hold each task to be listed
        let temp;

        // global variable to hold onto the data listener for tasks
        let task_query_listener;

        $(add).on("click", e => {
          e.preventDefault();

          // referencing the firebase db
          db.collection("tasks")
            .add({
              task: task.value,
              time_stamp: new Date().getTime(),
            })
            .then(docRef => {
              console.log("Document written with ID: ", docRef.id);
              result.html("Task added!");
              task.value = "";
            })
            .catch(error => {
              console.error("Error adding document: ", error);
              result.html("Oops! Something went wrong.");
            });

          // task_query_listener = db
          //   .collection("tasks")
          //   .onSnapshot(querySnapshot => {
          //     querySnapshot.forEach(doc => {
          //       console.log(doc.data());
          //       // creates list item element
          //       temp = document.createElement("li");
          //       // add's task text from Firebase to list item element
          //       temp.innerHTML = doc.data().task;
          //       // appends list item el with task test to unordered list dom element
          //       tasks.appendChild(temp);
          //     });
          //   });

          task_query_listener = db.collection("tasks").onSnapshot(snapshot => {
            console.log(snapshot.docs[0].data());
            while (tasks.children.length > 0) {
              tasks.removeChild(tasks.children[0]);
            }

            let resultArray = [];
            for (let i = 0; i < snapshot.docs.length; i++) {
              resultArray.push(snapshot.docs[i].data());
            }

            // sorting my todo tasks by the time they were created (descending order "b - a")
            resultArray.sort((a, b) => b.time_stamp - a.time_stamp);

            for (let i = 0; i < resultArray.length; i++) {
              temp = document.createElement("li");
              temp.innerHTML = resultArray[i].task;
              tasks.appendChild(temp);
            }
          });
        });
      });
    </script>
  </body>
</html>
